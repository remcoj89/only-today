---
import { AppContentWithI18n } from "./AppContentWithI18n";
import { Header } from "./Header";
import { MobileNav } from "./MobileNav";
import { Sidebar } from "./Sidebar";
import { AppClientProviders } from "@/components/providers/AppClientProviders";
import "./AppShell.css";
import "./PageTransition.css";
import "@/styles/tokens.css";
import "@/styles/global.css";
import "@/styles/utilities.css";

type Props = {
  title?: string;
  description?: string;
  noindex?: boolean;
  ogImage?: string;
  requiresAuth?: boolean;
};

const {
  title = "Only Today",
  description = "Only Today helpt je scherp focussen op vandaag.",
  noindex = false,
  ogImage = "/icons/og-image.svg",
  requiresAuth = true,
} = Astro.props;
const currentPath = Astro.url.pathname;
const gtmId = import.meta.env.PUBLIC_GTM_ID;
const appUrl = (import.meta.env.PUBLIC_APP_URL ?? "").replace(/\/$/, "");
const canonicalUrl = appUrl ? `${appUrl}${currentPath}` : undefined;
---

<!doctype html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {canonicalUrl ? <link rel="canonical" href={canonicalUrl} /> : null}
    <meta name="robots" content={noindex ? "noindex,nofollow" : "index,follow"} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    {canonicalUrl ? <meta property="og:url" content={canonicalUrl} /> : null}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <link rel="icon" type="image/svg+xml" href="/icons/favicon-32.svg" />
    <link rel="icon" sizes="16x16" href="/icons/favicon-16.svg" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.svg" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bellefair&family=JetBrains+Mono&family=Source+Sans+3:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script is:inline>
      const storedTheme = localStorage.getItem("onlyTodayTheme");
      if (storedTheme === "light" || storedTheme === "dark") {
        document.documentElement.dataset.theme = storedTheme;
      } else {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        document.documentElement.dataset.theme = prefersDark ? "dark" : "light";
      }
    </script>
    {gtmId ? (
      <script is:inline define:vars={{ gtmId }}>
        window.dataLayer = window.dataLayer || [];
        const consent = localStorage.getItem("onlyTodayAnalyticsConsent");
        if (consent === "granted" && gtmId) {
          (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
            const f = d.getElementsByTagName(s)[0];
            const j = d.createElement(s);
            const dl = l !== "dataLayer" ? `&l=${l}` : "";
            j.async = true;
            j.src = `https://www.googletagmanager.com/gtm.js?id=${i}${dl}`;
            f.parentNode?.insertBefore(j, f);
          })(window, document, "script", "dataLayer", gtmId);
        }
      </script>
    ) : null}
    {requiresAuth ? (
      <script is:inline>
        const accessToken = localStorage.getItem("onlyTodayAccessToken");
        if (!accessToken) {
          window.location.replace("/login");
        }
      </script>
    ) : null}
  </head>
  <body>
    <AppClientProviders client:load />
    <a href="#main-content" class="sr-skip-link">Spring naar inhoud</a>
    <div class="app-shell">
      <aside class="app-shell__sidebar">
        <Sidebar client:load initialPath={currentPath} />
      </aside>
      <div class="app-shell__main-column">
        <Header client:load />
        <main id="main-content" class="app-shell__main-content">
          <AppContentWithI18n client:load>
            <div class="page-transition">
              <slot />
            </div>
          </AppContentWithI18n>
        </main>
      </div>
      <MobileNav client:load initialPath={currentPath} />
    </div>
  </body>
</html>
